import React, { useEffect, useMemo, useRef, useState } from "react";

// === Configuration ===
const CONFIG = {
  LIFF_ID: "2007906947-zQ0mRjXg",
  LONGDO_API_KEY: "7fe4440cd70cb6961fe1fbfdcea94610",
  GAS_ENDPOINT:
    "https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID/exec",
};

// === Utilities ===
const loadScript = (src) =>
  new Promise((resolve, reject) => {
    if (document.querySelector(`script[src="${src}"]`)) return resolve();
    const s = document.createElement("script");
    s.src = src;
    s.async = true;
    s.onload = resolve;
    s.onerror = reject;
    document.head.appendChild(s);
  });

const toLongdoLink = (lat, lon) => `https://map.longdo.com/p/${lat},${lon}`;

const haversineKm = (a, b) => {
  if (!a || !b) return 0;
  const R = 6371;
  const dLat = ((b.lat - a.lat) * Math.PI) / 180;
  const dLon = ((b.lon - a.lon) * Math.PI) / 180;
  const lat1 = (a.lat * Math.PI) / 180;
  const lat2 = (b.lat * Math.PI) / 180;
  const sinDLat = Math.sin(dLat / 2);
  const sinDLon = Math.sin(dLon / 2);
  const x =
    sinDLat * sinDLat + Math.cos(lat1) * Math.cos(lat2) * sinDLon * sinDLon;
  const y = 2 * Math.atan2(Math.sqrt(x), Math.sqrt(1 - x));
  return R * y;
};

// === Fare Calculation ===
const calcFare = (kmFloat) => {
  const km = Math.ceil(kmFloat || 0);
  if (km <= 5) return 30;
  let fare = 30;
  const upTo12 = Math.min(km, 12);
  if (upTo12 > 5) fare += (upTo12 - 5) * 5; // km 6-12
  if (km >= 13) fare += 10; // km 13
  if (km >= 14) fare += (km - 13) * 15; // km 14+
  return fare;
};

// === UI Helpers ===
const Label = ({ children }) => (
  <label className="block text-sm font-medium mb-1">{children}</label>
);

const Card = ({ children }) => (
  <div className="bg-white shadow-md rounded-2xl p-4 mb-4">{children}</div>
);

const SectionTitle = ({ children }) => (
  <h2 className="text-lg font-semibold mb-2">{children}</h2>
);

const IconButton = ({ children, onClick }) => (
  <button
    type="button"
    onClick={onClick}
    className="px-3 py-1 bg-gray-200 rounded-lg mr-2"
  >
    {children}
  </button>
);

// === Map Picker ===
const MapPicker = ({ open, onClose, onPick, initial }) => {
  const containerRef = useRef(null);
  const mapRef = useRef(null);
  const markerRef = useRef(null);

  useEffect(() => {
    if (!open) return;
    const init = async () => {
      await loadScript(
        `https://api.longdo.com/map/?key=${CONFIG.LONGDO_API_KEY}`
      );
      const map = new window.longdo.Map({
        placeholder: containerRef.current,
        language: "th",
      });
      mapRef.current = map;
      const longdo = window.longdo;
      const center = initial?.lat
        ? { lon: initial.lon, lat: initial.lat }
        : { lon: 100.5018, lat: 13.7563 };
      map.location(center, true);
      markerRef.current = new longdo.Marker(center);
      map.Overlays.add(markerRef.current);

      map.Event.bind("click", function () {
        const loc = map.location();
        if (markerRef.current) map.Overlays.remove(markerRef.current);
        markerRef.current = new longdo.Marker(loc);
        map.Overlays.add(markerRef.current);
      });
    };
    init();
  }, [open]);

  if (!open) return null;

  return (
    <div className="fixed inset-0 bg-white z-50 flex flex-col">
      <div ref={containerRef} className="flex-1" />
      <div className="p-2 border-t flex justify-between">
        <IconButton onClick={onClose}>ยกเลิก</IconButton>
        <IconButton
          onClick={() => {
            if (!navigator.geolocation || !mapRef.current) return;
            navigator.geolocation.getCurrentPosition((pos) => {
              const { latitude: lat, longitude: lon } = pos.coords;
              mapRef.current.location({ lat, lon }, true);
            });
          }}
        >
          ตำแหน่งปัจจุบัน
        </IconButton>
        <IconButton
          onClick={() => {
            const loc = mapRef.current?.location();
            if (!loc) return;
            onPick({ lat: loc.lat, lon: loc.lon });
          }}
        >
          ใช้ตำแหน่งนี้
        </IconButton>
      </div>
    </div>
  );
};

// === Destination Row ===
const DestinationRow = ({ idx, dest, onChange, onRemove, onPickMap }) => {
  return (
    <Card>
      <div className="flex justify-between items-center mb-2">
        <h3 className="font-semibold">ปลายทาง #{idx + 1}</h3>
        <button
          className="text-red-500 text-sm"
          onClick={() => onRemove(dest.id)}
        >
          ลบ
        </button>
      </div>
      <Label>ชื่อผู้รับ</Label>
      <input
        type="text"
        className="w-full border rounded-lg p-2 mb-2"
        value={dest.name}
        onChange={(e) => onChange(dest.id, { name: e.target.value })}
      />
      <Label>เบอร์ติดต่อ</Label>
      <input
        type="text"
        className="w-full border rounded-lg p-2 mb-2"
        value={dest.phone}
        onChange={(e) => onChange(dest.id, { phone: e.target.value })}
      />
      <Label>แผนที่ปลายทาง</Label>
      <div className="flex mb-2">
        <IconButton onClick={() => onPickMap(dest.id)}>เลือกจากแผนที่</IconButton>
      </div>
      <input
        type="text"
        className="w-full border rounded-lg p-2 mb-2"
        placeholder="วางลิงก์ Longdo Map"
        value={dest.mapLink}
        onChange={(e) => onChange(dest.id, { mapLink: e.target.value })}
      />
      {dest.location ? (
        <div className="text-xs text-gray-500">
          lat: {dest.location.lat.toFixed(6)}, lon: {dest.location.lon.toFixed(6)}
        </div>
      ) : (
        <div className="text-xs text-gray-400">ยังไม่ระบุตำแหน่ง</div>
      )}
    </Card>
  );
};

// === Main App ===
export default function App() {
  const [liffReady, setLiffReady] = useState(false);
  const [profileName, setProfileName] = useState("");
  const [senderName, setSenderName] = useState("");
  const [senderPhone, setSenderPhone] = useState("");
  const [pickupAt, setPickupAt] = useState("");
  const [origin, setOrigin] = useState({ location: null, mapLink: "" });
  const [destinations, setDestinations] = useState([]);
  const [mapModal, setMapModal] = useState({ open: false, target: null });

  const parseLongdoLink = (link) => {
    try {
      if (!link) return null;
      const url = new URL(link);
      const parts = url.pathname.split("/");
      const last = parts.pop() || parts.pop();
      if (!last) return null;
      const [latStr, lonStr] = last.split(",");
      const lat = parseFloat(latStr);
      const lon = parseFloat(lonStr);
      if (isFinite(lat) && isFinite(lon)) return { lat, lon };
      return null;
    } catch (_) {
      return null;
    }
  };

  // Init LIFF
  useEffect(() => {
    const boot = async () => {
      if (!CONFIG.LIFF_ID || CONFIG.LIFF_ID === "YOUR_LIFF_ID") return;
      await loadScript(
        "https://static.line-scdn.net/liff/edge/versions/2.22.4/sdk.js"
      );
      await window.liff.init({ liffId: CONFIG.LIFF_ID });
      setLiffReady(true);
      try {
        const profile = await window.liff.getProfile();
        setProfileName(profile.displayName || "");
        setSenderName(profile.displayName || "");
      } catch (_) {}
    };
    boot();
  }, []);

  useEffect(() => {
    const loc = parseLongdoLink(origin.mapLink);
    if (loc) setOrigin((o) => ({ ...o, location: loc }));
  }, [origin.mapLink]);

  const updateDest = (id, patch) => {
    setDestinations((prev) =>
      prev.map((d) =>
        d.id === id
          ? {
              ...d,
              ...patch,
              ...(patch.mapLink
                ? { location: parseLongdoLink(patch.mapLink) || d.location }
                : {}),
            }
          : d
      )
    );
  };

  const addDest = () => {
    setDestinations((prev) => [
      ...prev,
      { id: crypto.randomUUID(), name: "", phone: "", location: null, mapLink: "" },
    ]);
  };

  const removeDest = (id) =>
    setDestinations((prev) => prev.filter((d) => d.id !== id));

  const perRoute = useMemo(() => {
    if (!origin.location) return [];
    return destinations.map((d) => {
      const km = d.location ? haversineKm(origin.location, d.location) : 0;
      const fare = d.location ? calcFare(km) : 0;
      return { id: d.id, km, fare };
    });
  }, [origin.location, destinations]);

  const totalFare = perRoute.reduce((s, r) => s + r.fare, 0);

  const handlePick = (coords) => {
    if (mapModal.target === "origin") {
      setOrigin((o) => ({
        ...o,
        location: coords,
        mapLink: toLongdoLink(coords.lat, coords.lon),
      }));
    } else {
      setDestinations((prev) =>
        prev.map((d) =>
          d.id === mapModal.target
            ? {
                ...d,
                location: coords,
                mapLink: toLongdoLink(coords.lat, coords.lon),
              }
            : d
        )
      );
    }
    setMapModal({ open: false, target: null });
  };

  const handleSubmit = async () => {
    const payload = {
      source: {
        name: senderName,
        phone: senderPhone,
        pickupAt,
        location: origin.location,
        mapLink: origin.mapLink,
      },
      destinations: destinations.map((d) => ({
        id: d.id,
        name: d.name,
        phone: d.phone,
        location: d.location,
        mapLink: d.mapLink,
      })),
      pricing: perRoute,
      totalFare: Math.round(totalFare),
      createdAt: new Date().toISOString(),
      meta: { liffReady },
    };

    const res = await fetch(CONFIG.GAS_ENDPOINT, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });

    if (!res.ok) {
      alert("ส่งข้อมูลไม่สำเร็จ กรุณาลองใหม่");
      return;
    }
    alert("ส่งข้อมูลสำเร็จ");
  };

  return (
    <div className="max-w-md mx-auto p-4 bg-gray-50 min-h-screen">
      <h1 className="text-xl font-bold mb-4">รับส่งพัสดุ</h1>
      <p className="mb-2">LIFF: {liffReady ? "พร้อม" : "รอ"}</p>

      {/* Origin */}
      <Card>
        <SectionTitle>ต้นทาง</SectionTitle>
        <Label>ชื่อผู้ส่ง</Label>
        <input
          type="text"
          className="w-full border rounded-lg p-2 mb-2"
          value={senderName}
          onChange={(e) => setSenderName(e.target.value)}
          placeholder="ดึงจาก LIFF อัตโนมัติ"
        />
        <Label>เบอร์ติดต่อ</Label>
        <input
          type="text"
          className="w-full border rounded-lg p-2 mb-2"
          value={senderPhone}
          onChange={(e) => setSenderPhone(e.target.value)}
          placeholder="08xxxxxxxx"
        />
        <Label>เวลานัดรับพัสดุ</Label>
        <input
          type="datetime-local"
          className="w-full border rounded-lg p-2 mb-2"
          value={pickupAt}
          onChange={(e) => setPickupAt(e.target.value)}
        />
        <Label>แผนที่ต้นทาง</Label>
        <div className="flex mb-2">
          <IconButton
            onClick={() => {
              if (!navigator.geolocation) return;
              navigator.geolocation.getCurrentPosition((pos) => {
                const { latitude: lat, longitude: lon } = pos.coords;
                setOrigin((o) => ({
                  ...o,
                  location: { lat, lon },
                  mapLink: toLongdoLink(lat, lon),
                }));
              });
            }}
          >
            ตำแหน่งปัจจุบัน
          </IconButton>
          <IconButton onClick={() => setMapModal({ open: true, target: "origin" })}>
            เลือกจากแผนที่
          </IconButton>
        </div>
        <input
          type="text"
          className="w-full border rounded-lg p-2 mb-2"
          placeholder="วางลิงก์ Longdo Map"
          value={origin.mapLink}
          onChange={(e) => setOrigin((o) => ({ ...o, mapLink: e.target.value }))}
        />
        {origin.location ? (
          <div className="text-xs text-gray-500">
            lat: {origin.location.lat.toFixed(6)}, lon: {origin.location.lon.toFixed(6)}
          </div>
        ) : (
          <div className="text-xs text-gray-400">ยังไม่ระบุตำแหน่ง</div>
        )}
      </Card>

      {/* Destinations */}
      <div className="flex justify-between items-center mb-2">
        <SectionTitle>ปลายทาง</SectionTitle>
        <button
          className="px-3 py-1 bg-blue-500 text-white rounded-lg"
          onClick={addDest}
        >
          เพิ่มปลายทาง
        </button>
      </div>
      {destinations.length === 0 && (
        <div className="text-sm text-gray-400 mb-2">
          ยังไม่มีปลายทาง กด “เพิ่มปลายทาง”
        </div>
      )}
      {destinations.map((d, i) => (
        <DestinationRow
          key={d.id}
          idx={i}
          dest={d}
          onChange={updateDest}
          onRemove={removeDest}
          onPickMap={(id) => setMapModal({ open: true, target: id })}
        />
