<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบรับส่งพัสดุ</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Longdo Map API -->
    <script src="https://api.longdo.com/map/?key=7fe4440cd70cb6961fe1fbfdcea94610"></script>

    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- Custom Styles -->
    <style>
        /* Use Inter font from Google Fonts */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Sarabun:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Sarabun', 'Inter', sans-serif;
            background-color: #f8f9fa;
        }
        /* Custom styles for better UX */
        .form-section {
            background-color: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .btn-primary {
            background-color: #06C755; /* LINE Green */
            color: white;
            font-weight: 600;
            border-radius: 0.5rem;
            padding: 0.75rem 1.5rem;
            transition: background-color 0.3s;
        }
        .btn-primary:hover {
            background-color: #05a546;
        }
        .btn-secondary {
            background-color: #e9ecef;
            color: #495057;
            font-weight: 500;
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            transition: background-color 0.3s;
        }
        .btn-secondary:hover {
            background-color: #dee2e6;
        }
        .input-field {
            width: 100%;
            border: 1px solid #ced4da;
            border-radius: 0.5rem;
            padding: 0.75rem;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        .input-field:focus {
            outline: none;
            border-color: #06C755;
            box-shadow: 0 0 0 2px rgba(6, 199, 85, 0.2);
        }
        /* Modal styles */
        #mapModal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            position: relative;
            background-color: #fefefe;
            margin: auto;
            border-radius: 0.5rem;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        #map {
            flex-grow: 1;
            width: 100%;
        }
        /* Loading overlay */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #06C755;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Notification Modal */
        #notification-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        #notification-modal.show {
            opacity: 1;
            visibility: visible;
        }
        .notification-content {
            background: white;
            padding: 2rem;
            border-radius: 0.75rem;
            text-align: center;
            max-width: 90%;
            width: 350px;
            box-shadow: 0 10px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        }
        .notification-content .icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        .notification-content .icon.success { color: #10B981; }
        .notification-content .icon.error { color: #EF4444; }
    </style>
</head>
<body class="bg-gray-50">

    <div id="loading-overlay" class="hidden">
        <div class="spinner"></div>
    </div>

    <div class="container mx-auto max-w-lg p-4">
        <header class="text-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">สร้างรายการส่งพัสดุ</h1>
            <p class="text-gray-500 mt-1">กรุณากรอกข้อมูลให้ครบถ้วน</p>
        </header>

        <form id="deliveryForm">
            <!-- Origin Section -->
            <div class="form-section">
                <h2 class="text-xl font-semibold text-gray-700 border-b pb-2 mb-4 flex items-center">
                    <i class="fas fa-box-open mr-3 text-green-500"></i>ข้อมูลต้นทาง
                </h2>
                <div class="space-y-4">
                    <div>
                        <label for="senderName" class="block text-sm font-medium text-gray-600 mb-1">ชื่อผู้ส่ง</label>
                        <input type="text" id="senderName" class="input-field bg-gray-100" readonly>
                    </div>
                    <div>
                        <label for="senderPhone" class="block text-sm font-medium text-gray-600 mb-1">เบอร์ติดต่อ</label>
                        <input type="tel" id="senderPhone" class="input-field" placeholder="กรอกเบอร์โทรศัพท์" required>
                    </div>
                    <div>
                        <label for="pickupTime" class="block text-sm font-medium text-gray-600 mb-1">เวลานัดรับ</label>
                        <input type="datetime-local" id="pickupTime" class="input-field" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-2">แผนที่ต้นทาง</label>
                        <div class="flex space-x-2">
                            <button type="button" id="currentLocationBtn" class="btn-secondary w-full flex items-center justify-center"><i class="fas fa-location-arrow mr-2"></i>ตำแหน่งปัจจุบัน</button>
                            <button type="button" id="originMapBtn" class="btn-secondary w-full flex items-center justify-center"><i class="fas fa-map-marked-alt mr-2"></i>เลือกจากแผนที่</button>
                        </div>
                        <div id="originAddress" class="mt-3 p-3 bg-gray-50 border rounded-lg text-gray-600 text-sm min-h-[40px]">
                            ยังไม่ได้เลือกตำแหน่ง
                        </div>
                        <input type="hidden" id="originCoords">
                    </div>
                </div>
            </div>

            <!-- Destinations Section -->
            <div id="destinations-container">
                <!-- Destination items will be injected here -->
            </div>

            <button type="button" id="addDestinationBtn" class="w-full py-3 mb-6 border-2 border-dashed border-green-400 text-green-600 font-semibold rounded-lg hover:bg-green-50 transition-colors flex items-center justify-center">
                <i class="fas fa-plus-circle mr-2"></i>เพิ่มปลายทาง
            </button>

            <!-- Summary Section -->
            <div class="form-section">
                <h2 class="text-xl font-semibold text-gray-700 border-b pb-2 mb-4 flex items-center">
                    <i class="fas fa-receipt mr-3 text-green-500"></i>สรุปข้อมูล
                </h2>
                <div class="space-y-2 text-gray-700">
                    <div class="flex justify-between">
                        <span>ระยะทางรวม:</span>
                        <span id="totalDistance" class="font-semibold">0.00 กม.</span>
                    </div>
                    <div class="flex justify-between text-xl">
                        <span class="font-semibold">ค่าบริการ (โดยประมาณ):</span>
                        <span id="shippingFee" class="font-bold text-green-600">฿0.00</span>
                    </div>
                </div>
            </div>

            <button type="submit" class="btn-primary w-full text-lg">
                ยืนยันและสร้างรายการ
            </button>
        </form>
    </div>

    <!-- Map Modal -->
    <div id="mapModal">
        <div class="modal-content">
            <div class="p-4 bg-white border-b flex items-center">
                <input type="text" id="mapSearch" class="input-field" placeholder="ค้นหาสถานที่...">
                <button type="button" id="closeMapBtn" class="ml-2 text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <div id="map"></div>
            <div class="p-4 bg-white border-t">
                <div id="selectedMapAddress" class="mb-3 p-2 bg-gray-100 rounded-md text-sm text-gray-700">กรุณาปักหมุดบนแผนที่</div>
                <button type="button" id="confirmLocationBtn" class="btn-primary w-full">ยืนยันตำแหน่งนี้</button>
            </div>
        </div>
    </div>

    <!-- Notification Modal -->
    <div id="notification-modal">
        <div class="notification-content">
            <div id="notification-icon" class="icon"></div>
            <p id="notification-message" class="text-gray-700 mb-4"></p>
            <button id="notification-close-btn" class="btn-primary">ตกลง</button>
        </div>
    </div>


    <!-- LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        // --- CONFIGURATION ---
        // TODO: กรุณาใส่ค่าจริงของคุณที่นี่
        const LIFF_ID = "2007906947-zQ0mRjXg"; 
        const LONGDO_MAP_API_KEY = document.querySelector('script[src*="longdo.com"]').src.split('key=')[1];
        const GAS_WEB_APP_URL = "YOUR_GOOGLE_APPS_SCRIPT_URL";

        // --- DOM ELEMENTS ---
        const form = document.getElementById('deliveryForm');
        const senderNameInput = document.getElementById('senderName');
        const pickupTimeInput = document.getElementById('pickupTime');
        const addDestinationBtn = document.getElementById('addDestinationBtn');
        const destinationsContainer = document.getElementById('destinations-container');
        const totalDistanceEl = document.getElementById('totalDistance');
        const shippingFeeEl = document.getElementById('shippingFee');
        const loadingOverlay = document.getElementById('loading-overlay');
        
        // Map Modal Elements
        const mapModal = document.getElementById('mapModal');
        const mapSearchInput = document.getElementById('mapSearch');
        const closeMapBtn = document.getElementById('closeMapBtn');
        const confirmLocationBtn = document.getElementById('confirmLocationBtn');
        const selectedMapAddressEl = document.getElementById('selectedMapAddress');

        // Notification Modal Elements
        const notificationModal = document.getElementById('notification-modal');
        const notificationIcon = document.getElementById('notification-icon');
        const notificationMessage = document.getElementById('notification-message');
        const notificationCloseBtn = document.getElementById('notification-close-btn');

        // --- STATE VARIABLES ---
        let destinationCounter = 0;
        let map;
        let currentMapTarget = null; // e.g., 'origin', 'destination-1'
        let selectedLocation = null; // { lat, lon, address }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', initializeApp);

        async function initializeApp() {
            showLoading(true);
            try {
                // Check for placeholder values before initializing
                if (LIFF_ID === "2007906947-zQ0mRjXg") {
                    throw new Error("Config Error: กรุณาใส่ LIFF ID ของคุณในโค้ด");
                }
                if (LONGDO_MAP_API_KEY === "https://api.longdo.com/map/?key=7fe4440cd70cb6961fe1fbfdcea94610") {
                    throw new Error("Config Error: กรุณาใส่ Longdo Map API Key ของคุณในโค้ด");
                }

                await liff.init({ liffId: LIFF_ID });
                
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return; // Stop execution until login completes and page reloads
                }

                // This code runs only after successful login
                const profile = await liff.getProfile();
                senderNameInput.value = profile.displayName;
                
                setupEventListeners();
                addDestination(); // Add the first destination by default
                setDefaultPickupTime();
                showLoading(false); // Hide loading only on full success

            } catch (error) {
                console.error("Initialization failed", error);
                let errorMessage = "เกิดข้อผิดพลาดที่ไม่คาดคิด กรุณาลองใหม่อีกครั้ง";
                if (error.message.includes("Config Error")) {
                    errorMessage = error.message.replace("Config Error: ", "");
                } else if (error.toString().includes("channel not found")) {
                    errorMessage = "เกิดข้อผิดพลาด: ไม่พบ LIFF Channel ID ของคุณ กรุณาตรวจสอบค่า LIFF_ID ให้ถูกต้อง";
                }
                showMessage(errorMessage, true);
                showLoading(false); // Hide loading on error
            }
        }

        function setDefaultPickupTime() {
            const now = new Date();
            now.setHours(now.getHours() + 1); // Add 1 hour to current time
            const year = now.getFullYear();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const day = now.getDate().toString().padStart(2, '0');
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            pickupTimeInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        // --- EVENT LISTENERS ---
        function setupEventListeners() {
            addDestinationBtn.addEventListener('click', addDestination);
            form.addEventListener('submit', handleFormSubmit);

            document.getElementById('currentLocationBtn').addEventListener('click', getCurrentLocation);
            document.getElementById('originMapBtn').addEventListener('click', () => openMapModal('origin'));

            closeMapBtn.addEventListener('click', closeMapModal);
            confirmLocationBtn.addEventListener('click', confirmLocation);
            mapSearchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    searchMap();
                }
            });
            notificationCloseBtn.addEventListener('click', () => notificationModal.classList.remove('show'));
        }

        // --- DESTINATION MANAGEMENT ---
        function addDestination() {
            destinationCounter++;
            const id = `destination-${destinationCounter}`;
            const destinationHTML = `
                <div class="form-section" id="${id}">
                    <div class="flex justify-between items-center border-b pb-2 mb-4">
                        <h2 class="text-xl font-semibold text-gray-700 flex items-center">
                            <i class="fas fa-map-marker-alt mr-3 text-red-500"></i>ข้อมูลปลายทาง #${destinationCounter}
                        </h2>
                        ${destinationCounter > 1 ? `<button type="button" class="text-red-500 hover:text-red-700 remove-destination-btn" data-target="${id}">&times; ลบ</button>` : ''}
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label for="recipientName-${id}" class="block text-sm font-medium text-gray-600 mb-1">ชื่อผู้รับ</label>
                            <input type="text" id="recipientName-${id}" class="input-field" placeholder="กรอกชื่อผู้รับ" required>
                        </div>
                        <div>
                            <label for="recipientPhone-${id}" class="block text-sm font-medium text-gray-600 mb-1">เบอร์ติดต่อผู้รับ</label>
                            <input type="tel" id="recipientPhone-${id}" class="input-field" placeholder="กรอกเบอร์โทรศัพท์" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-2">แผนที่ปลายทาง</label>
                            <button type="button" class="btn-secondary w-full destination-map-btn" data-target="${id}"><i class="fas fa-map-marked-alt mr-2"></i>เลือกจากแผนที่</button>
                            <div id="address-${id}" class="mt-3 p-3 bg-gray-50 border rounded-lg text-gray-600 text-sm min-h-[40px]">
                                ยังไม่ได้เลือกตำแหน่ง
                            </div>
                            <input type="hidden" id="coords-${id}">
                        </div>
                    </div>
                </div>
            `;
            destinationsContainer.insertAdjacentHTML('beforeend', destinationHTML);
            
            document.querySelector(`.destination-map-btn[data-target="${id}"]`).addEventListener('click', () => openMapModal(id));
            if (destinationCounter > 1) {
                document.querySelector(`.remove-destination-btn[data-target="${id}"]`).addEventListener('click', (e) => removeDestination(e.target.dataset.target));
            }
        }

        function removeDestination(id) {
            document.getElementById(id).remove();
            calculateTotal();
        }

        // --- LOCATION & MAP ---
        function getCurrentLocation() {
            showLoading(true);
            if (!navigator.geolocation) {
                showMessage("เบราว์เซอร์ของคุณไม่รองรับการระบุตำแหน่ง", true);
                showLoading(false);
                return;
            }
            navigator.geolocation.getCurrentPosition(
                position => {
                    const coords = { lat: position.coords.latitude, lon: position.coords.longitude };
                    getAddressFromCoords(coords, (address) => {
                        updateLocationUI('origin', coords, address);
                        showLoading(false);
                    });
                },
                () => {
                    showMessage("ไม่สามารถดึงตำแหน่งปัจจุบันได้ กรุณาเปิด GPS", true);
                    showLoading(false);
                }
            );
        }

        function openMapModal(target) {
            currentMapTarget = target;
            mapModal.style.display = 'block';
            if (!map) initMap();
        }

        function closeMapModal() {
            mapModal.style.display = 'none';
            selectedMapAddressEl.textContent = 'กรุณาปักหมุดบนแผนที่';
            mapSearchInput.value = '';
            selectedLocation = null;
        }

        function initMap() {
            map = new longdo.Map({ placeholder: document.getElementById('map') });
            map.Event.bind('click', (e) => {
                const location = map.location();
                const marker = new longdo.Marker(location, { title: 'ตำแหน่งที่เลือก' });
                map.Overlays.clear();
                map.Overlays.add(marker);
                map.zoom(16, true);
                const coords = { lat: location.lat, lon: location.lon };
                getAddressFromCoords(coords, (address) => {
                    selectedLocation = { ...coords, address };
                    selectedMapAddressEl.textContent = address;
                });
            });
        }

        function searchMap() {
            const keyword = mapSearchInput.value;
            if (!keyword) return;
            map.Search.search(keyword, {
                callback: (result) => {
                    if (result.data.length > 0) {
                        const firstResult = result.data[0];
                        const location = { lat: firstResult.lat, lon: firstResult.lon };
                        map.location(location, true);
                        map.zoom(16, true);
                        const marker = new longdo.Marker(location);
                        map.Overlays.clear();
                        map.Overlays.add(marker);
                        getAddressFromCoords(location, (address) => {
                            selectedLocation = { ...location, address };
                            selectedMapAddressEl.textContent = address;
                        });
                    } else {
                        showMessage('ไม่พบสถานที่ที่ค้นหา', true);
                    }
                }
            });
        }

        function getAddressFromCoords(coords, callback) {
            map.Search.search(coords, {
                callback: (result) => {
                    const address = result.data.length > 0 ? `${result.data[0].name}, ${result.data[0].address}` : 'ไม่สามารถระบุที่อยู่ได้';
                    callback(address);
                }
            });
        }

        function confirmLocation() {
            if (selectedLocation && currentMapTarget) {
                updateLocationUI(currentMapTarget, { lat: selectedLocation.lat, lon: selectedLocation.lon }, selectedLocation.address);
                closeMapModal();
            } else {
                showMessage('กรุณาเลือกตำแหน่งบนแผนที่ก่อน', true);
            }
        }

        function updateLocationUI(target, coords, address) {
            const addressEl = (target === 'origin') ? document.getElementById('originAddress') : document.getElementById(`address-${target}`);
            const coordsEl = (target === 'origin') ? document.getElementById('originCoords') : document.getElementById(`coords-${target}`);
            addressEl.textContent = address;
            coordsEl.value = `${coords.lat},${coords.lon}`;
            calculateTotal();
        }

        // --- CALCULATION ---
        function calculateTotal() {
            const originCoordsStr = document.getElementById('originCoords').value;
            if (!originCoordsStr) return;

            const waypoints = [longdo.Util.stringToLocation(originCoordsStr)];
            document.querySelectorAll('[id^="destination-"]').forEach(el => {
                const coordsStr = el.querySelector('[id^="coords-"]').value;
                if (coordsStr) waypoints.push(longdo.Util.stringToLocation(coordsStr));
            });

            if (waypoints.length < 2) {
                totalDistanceEl.textContent = '0.00 กม.';
                shippingFeeEl.textContent = '฿0.00';
                return;
            }
            if (!map) map = new longdo.Map({ placeholder: document.createElement('div') });

            map.Route.get({
                locationList: waypoints,
                callback: (result) => {
                    const distanceKm = result.distance / 1000;
                    const fee = calculateFee(distanceKm);
                    totalDistanceEl.textContent = `${distanceKm.toFixed(2)} กม.`;
                    shippingFeeEl.textContent = `฿${fee.toFixed(2)}`;
                }
            });
        }

        function calculateFee(km) {
            if (km <= 0) return 0;
            if (km <= 5) return 30;
            let fee = 30;
            if (km > 5 && km < 13) {
                fee += (km - 5) * 5;
            } else if (km >= 13) {
                fee += (12 - 5) * 5; // Fee up to 12km
                fee += 10; // Fee for the 13th km
                if (km > 13) fee += (km - 13) * 15; // Fee after 13km
            }
            return fee;
        }

        // --- FORM SUBMISSION ---
        async function handleFormSubmit(e) {
            e.preventDefault();
            showLoading(true);

            const originCoords = document.getElementById('originCoords').value.split(',');
            const formData = {
                origin: {
                    name: senderNameInput.value,
                    phone: document.getElementById('senderPhone').value,
                    pickupTime: pickupTimeInput.value,
                    address: document.getElementById('originAddress').textContent,
                    lat: originCoords[0] ? parseFloat(originCoords[0]) : null,
                    lon: originCoords[1] ? parseFloat(originCoords[1]) : null,
                },
                destinations: [],
                summary: {
                    totalDistance: totalDistanceEl.textContent,
                    shippingFee: shippingFeeEl.textContent,
                }
            };
            
            let isFormValid = !!(formData.origin.phone && formData.origin.pickupTime && formData.origin.lat);

            document.querySelectorAll('[id^="destination-"]').forEach(el => {
                const id = el.id;
                const destCoords = document.getElementById(`coords-${id}`).value.split(',');
                const destinationData = {
                    name: document.getElementById(`recipientName-${id}`).value,
                    phone: document.getElementById(`recipientPhone-${id}`).value,
                    address: document.getElementById(`address-${id}`).textContent,
                    lat: destCoords[0] ? parseFloat(destCoords[0]) : null,
                    lon: destCoords[1] ? parseFloat(destCoords[1]) : null,
                };
                if (!destinationData.name || !destinationData.phone || !destinationData.lat) isFormValid = false;
                formData.destinations.push(destinationData);
            });
            
            if (!isFormValid) {
                showMessage('กรุณากรอกข้อมูลให้ครบถ้วนทุกช่อง และปักหมุดให้ครบทุกจุดหมาย', true);
                showLoading(false);
                return;
            }

            try {
                // In a real scenario, you would remove 'no-cors' and handle CORS on your GAS backend
                await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                showMessage('สร้างรายการสำเร็จ!', false);
                setTimeout(() => {
                    if (liff.isInClient()) liff.closeWindow();
                }, 2000);

            } catch (error) {
                console.error('Error submitting form:', error);
                showMessage('เกิดข้อผิดพลาดในการส่งข้อมูล กรุณาลองใหม่อีกครั้ง', true);
            } finally {
                showLoading(false);
            }
        }

        // --- UTILITIES ---
        function showLoading(isLoading) {
            loadingOverlay.classList.toggle('hidden', !isLoading);
        }

        function showMessage(message, isError = false) {
            notificationMessage.textContent = message;
            if (isError) {
                notificationIcon.innerHTML = '<i class="fas fa-times-circle"></i>';
                notificationIcon.className = 'icon error';
            } else {
                notificationIcon.innerHTML = '<i class="fas fa-check-circle"></i>';
                notificationIcon.className = 'icon success';
            }
            notificationModal.classList.add('show');
        }

    </script>
</body>
</html>
