import React, { useEffect, useMemo, useRef, useState } from "react";

// === Configuration ===
const CONFIG = {
  LIFF_ID: "2007906947-zQ0mRjXg",
  LONGDO_API_KEY: "7fe4440cd70cb6961fe1fbfdcea94610",
  GAS_ENDPOINT: "https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID/exec",
};

// === Utilities ===
const loadScript = (src) =>
  new Promise((resolve, reject) => {
    if (document.querySelector(`script[src="${src}"]`)) return resolve();
    const s = document.createElement("script");
    s.src = src;
    s.async = true;
    s.onload = resolve;
    s.onerror = reject;
    document.head.appendChild(s);
  });

const toLongdoLink = (lat, lon) => `https://map.longdo.com/p/${lat},${lon}`;

const haversineKm = (a, b) => {
  if (!a || !b) return 0;
  const R = 6371;
  const dLat = ((b.lat - a.lat) * Math.PI) / 180;
  const dLon = ((b.lon - a.lon) * Math.PI) / 180;
  const lat1 = (a.lat * Math.PI) / 180;
  const lat2 = (b.lat * Math.PI) / 180;
  const sinDLat = Math.sin(dLat / 2);
  const sinDLon = Math.sin(dLon / 2);
  const x = sinDLat * sinDLat + Math.cos(lat1) * Math.cos(lat2) * sinDLon * sinDLon;
  const y = 2 * Math.atan2(Math.sqrt(x), Math.sqrt(1 - x));
  return R * y;
};

// Fare rule:
// 0-5 km => flat 30 THB
// >5 to 12 km => +5 THB per km
// 13th km => +10 THB
// 14 km and beyond => +15 THB per km (from km 14 onward)
const calcFare = (kmFloat) => {
  const km = Math.ceil(kmFloat || 0);
  if (km <= 5) return 30;
  let fare = 30;
  const upTo12 = Math.min(km, 12);
  if (upTo12 > 5) fare += (upTo12 - 5) * 5; // km 6-12
  if (km >= 13) fare += 10; // km 13
  if (km >= 14) fare += (km - 13) * 15; // km 14+
  return fare;
};

const Input = (props) => (
  <input
    {...props}
    className={
      "w-full rounded-2xl border border-gray-200 px-4 py-3 text-base outline-none focus:ring-2 focus:ring-black " +
      (props.className || "")
    }
  />
);

const Label = ({ children }) => (
  <label className="block text-sm font-medium text-gray-700 mb-1">{children}</label>
);

const Card = ({ children, className }) => (
  <div className={`rounded-2xl bg-white shadow-sm border border-gray-100 p-4 ${className || ""}`}>{children}</div>
);

const SectionTitle = ({ children }) => (
  <h2 className="text-lg font-semibold text-gray-900 mb-3">{children}</h2>
);

const IconButton = ({ children, onClick, type = "button" }) => (
  <button
    type={type}
    onClick={onClick}
    className="rounded-xl border border-gray-200 px-3 py-2 text-sm hover:bg-gray-50 active:scale-[0.99]"
  >
    {children}
  </button>
);

// === Map Picker (Longdo) ===
const MapPicker = ({ open, onClose, onPick, initial }) => {
  const containerRef = useRef(null);
  const mapRef = useRef(null);
  const markerRef = useRef(null);

  useEffect(() => {
    if (!open) return;
    const init = async () => {
      await loadScript(`https://api.longdo.com/map/?key=${CONFIG.LONGDO_API_KEY}`);
      // eslint-disable-next-line no-undef
      const map = new window.longdo.Map({
        placeholder: containerRef.current,
        language: 'th',
      });
      mapRef.current = map;
      // eslint-disable-next-line no-undef
      const longdo = window.longdo;

      const center = initial?.lat ? { lon: initial.lon, lat: initial.lat } : { lon: 100.5018, lat: 13.7563 };
      map.location(center, true);
      markerRef.current = new longdo.Marker(center);
      map.Overlays.add(markerRef.current);

      map.Event.bind('click', function () {
        const loc = map.location();
        if (markerRef.current) map.Overlays.remove(markerRef.current);
        markerRef.current = new longdo.Marker(loc);
        map.Overlays.add(markerRef.current);
      });
    };
    init();
    return () => {
      // no explicit destroy needed in Longdo
    };
  }, [open]);

  if (!open) return null;

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50">
      <div className="w-full max-w-md rounded-2xl bg-white p-3 shadow-xl">
        <div ref={containerRef} className="h-80 w-full rounded-xl bg-gray-100" />
        <div className="mt-3 flex items-center justify-between gap-2">
          <IconButton onClick={onClose}>ยกเลิก</IconButton>
          <div className="flex gap-2">
            <IconButton
              onClick={() => {
                if (!navigator.geolocation || !mapRef.current) return;
                navigator.geolocation.getCurrentPosition((pos) => {
                  const { latitude: lat, longitude: lon } = pos.coords;
                  mapRef.current.location({ lat, lon }, true);
                });
              }}
            >
              ตำแหน่งปัจจุบัน
            </IconButton>
            <button
              className="rounded-xl bg-black px-4 py-2 text-white"
              onClick={() => {
                const loc = mapRef.current?.location();
                if (!loc) return;
                onPick({ lat: loc.lat, lon: loc.lon });
              }}
            >
              ใช้ตำแหน่งนี้
            </button>
          </div>
        </div>
      </div>
    </div>
  );
};

// === Destination Row ===
const DestinationRow = ({ idx, dest, onChange, onRemove, onPickMap }) => {
  return (
    <Card className="space-y-3">
      <div className="flex items-center justify-between">
        <div className="text-sm font-semibold">ปลายทาง #{idx + 1}</div>
        <IconButton onClick={() => onRemove(dest.id)}>ลบ</IconButton>
      </div>
      <div className="grid grid-cols-1 gap-3">
        <div>
          <Label>ชื่อผู้รับ</Label>
          <Input
            placeholder="เช่น คุณเอ"
            value={dest.name}
            onChange={(e) => onChange(dest.id, { name: e.target.value })}
          />
        </div>
        <div>
          <Label>เบอร์ติดต่อ</Label>
          <Input
            placeholder="08xxxxxxxx"
            value={dest.phone}
            onChange={(e) => onChange(dest.id, { phone: e.target.value })}
          />
        </div>
        <div className="space-y-2">
          <Label>แผนที่ปลายทาง</Label>
          <div className="flex gap-2">
            <IconButton onClick={() => onPickMap(dest.id)}>เลือกจากแผนที่</IconButton>
            <Input
              placeholder="วางลิงก์ Longdo Map ได้ เช่น https://map.longdo.com/p/13.7,100.5"
              value={dest.mapLink || ""}
              onChange={(e) => onChange(dest.id, { mapLink: e.target.value })}
            />
          </div>
          {dest.location ? (
            <div className="text-sm text-gray-600">
              lat: {dest.location.lat.toFixed(6)}, lon: {dest.location.lon.toFixed(6)}
            </div>
          ) : (
            <div className="text-sm text-gray-400">ยังไม่ระบุตำแหน่ง</div>
          )}
        </div>
      </div>
    </Card>
  );
};

// === Main App ===
export default function App() {
  // LIFF profile
  const [liffReady, setLiffReady] = useState(false);
  const [profileName, setProfileName] = useState("");

  // Origin
  const [senderName, setSenderName] = useState("");
  const [senderPhone, setSenderPhone] = useState("");
  const [pickupAt, setPickupAt] = useState("");
  const [origin, setOrigin] = useState({ location: null, mapLink: "" });

  // Destinations
  const [destinations, setDestinations] = useState([]);

  // Modals
  const [mapModal, setMapModal] = useState({ open: false, target: null }); // target: 'origin' | destId

  const parseLongdoLink = (link) => {
    try {
      if (!link) return null;
      const url = new URL(link);
      const parts = url.pathname.split("/");
      const last = parts.pop() || parts.pop();
      if (!last) return null;
      const [latStr, lonStr] = last.split(",");
      const lat = parseFloat(latStr);
      const lon = parseFloat(lonStr);
      if (isFinite(lat) && isFinite(lon)) return { lat, lon };
      return null;
    } catch (_) {
      return null;
    }
  };

  // Init LIFF
  useEffect(() => {
    const boot = async () => {
      if (!CONFIG.LIFF_ID || CONFIG.LIFF_ID === "YOUR_LIFF_ID") return; // skip if not configured
      await loadScript("https://static.line-scdn.net/liff/edge/versions/2.22.4/sdk.js");
      // eslint-disable-next-line no-undef
      await window.liff.init({ liffId: CONFIG.LIFF_ID });
      setLiffReady(true);
      try {
        // eslint-disable-next-line no-undef
        const profile = await window.liff.getProfile();
        setProfileName(profile.displayName || "");
        setSenderName(profile.displayName || "");
      } catch (_) {}
    };
    boot();
  }, []);

  // When user pastes Longdo link into origin or destinations, parse to location
  useEffect(() => {
    const loc = parseLongdoLink(origin.mapLink);
    if (loc) setOrigin((o) => ({ ...o, location: loc }));
  }, [origin.mapLink]);

  const updateDest = (id, patch) => {
    setDestinations((prev) =>
      prev.map((d) => (d.id === id ? { ...d, ...patch, ...(patch.mapLink ? { location: parseLongdoLink(patch.mapLink) || d.location } : {}) } : d))
    );
  };

  const addDest = () => {
    setDestinations((prev) => [
      ...prev,
      { id: crypto.randomUUID(), name: "", phone: "", location: null, mapLink: "" },
    ]);
  };

  const removeDest = (id) => setDestinations((prev) => prev.filter((d) => d.id !== id));

  const allItems = useMemo(() => {
    return destinations.map((d) => ({ id: d.id, location: d.location }));
  }, [destinations]);

  const perRoute = useMemo(() => {
    if (!origin.location) return [];
    return destinations.map((d) => {
      const km = d.location ? haversineKm(origin.location, d.location) : 0;
      const fare = d.location ? calcFare(km) : 0;
      return { id: d.id, km, fare };
    });
  }, [origin.location, destinations]);

  const totalFare = perRoute.reduce((s, r) => s + r.fare, 0);

  const handlePick = (coords) => {
    if (mapModal.target === "origin") {
      setOrigin((o) => ({ ...o, location: coords, mapLink: toLongdoLink(coords.lat, coords.lon) }));
    } else {
      setDestinations((prev) => prev.map((d) => (d.id === mapModal.target ? { ...d, location: coords, mapLink: toLongdoLink(coords.lat, coords.lon) } : d)));
    }
    setMapModal({ open: false, target: null });
  };

  const handleSubmit = async () => {
    const payload = {
      source: {
        name: senderName,
        phone: senderPhone,
        pickupAt,
        location: origin.location,
        mapLink: origin.mapLink,
      },
      destinations: destinations.map((d) => ({ id: d.id, name: d.name, phone: d.phone, location: d.location, mapLink: d.mapLink })),
      pricing: perRoute,
      totalFare: Math.round(totalFare),
      createdAt: new Date().toISOString(),
      meta: { liffReady },
    };

    const res = await fetch(CONFIG.GAS_ENDPOINT, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });

    if (!res.ok) {
      alert("ส่งข้อมูลไม่สำเร็จ กรุณาลองใหม่");
      return;
    }
    alert("ส่งข้อมูลสำเร็จ");
  };

  return (
    <div className="min-h-screen bg-gray-50">
      <header className="sticky top-0 z-40 border-b border-gray-200 bg-white/90 backdrop-blur">
        <div className="mx-auto max-w-xl px-4 py-3 flex items-center justify-between">
          <div className="text-base font-semibold">รับส่งพัสดุ</div>
          <div className="text-xs text-gray-600">LIFF {liffReady ? "พร้อม" : "รอ"}</div>
        </div>
      </header>

      <main className="mx-auto max-w-xl px-4 py-4 space-y-4">
        {/* Origin */}
        <Card className="space-y-4">
          <SectionTitle>ต้นทาง</SectionTitle>
          <div className="grid grid-cols-1 gap-3">
            <div>
              <Label>ชื่อผู้ส่ง</Label>
              <Input value={senderName} onChange={(e) => setSenderName(e.target.value)} placeholder="ดึงจาก LIFF อัตโนมัติ" />
            </div>
            <div>
              <Label>เบอร์ติดต่อ</Label>
              <Input value={senderPhone} onChange={(e) => setSenderPhone(e.target.value)} placeholder="08xxxxxxxx" />
            </div>
            <div>
              <Label>เวลานัดรับพัสดุ</Label>
              <Input type="datetime-local" value={pickupAt} onChange={(e) => setPickupAt(e.target.value)} />
            </div>
            <div className="space-y-2">
              <Label>แผนที่ต้นทาง</Label>
              <div className="flex gap-2">
                <IconButton
                  onClick={() => {
                    if (!navigator.geolocation) return;
                    navigator.geolocation.getCurrentPosition((pos) => {
                      const { latitude: lat, longitude: lon } = pos.coords;
                      setOrigin((o) => ({ ...o, location: { lat, lon }, mapLink: toLongdoLink(lat, lon) }));
                    });
                  }}
                >
                  ตำแหน่งปัจจุบัน
                </IconButton>
                <IconButton onClick={() => setMapModal({ open: true, target: "origin" })}>เลือกจากแผนที่</IconButton>
                <Input
                  placeholder="วางลิงก์ Longdo Map ได้ เช่น https://map.longdo.com/p/13.7,100.5"
                  value={origin.mapLink}
                  onChange={(e) => setOrigin((o) => ({ ...o, mapLink: e.target.value }))}
                />
              </div>
              {origin.location ? (
                <div className="text-sm text-gray-600">
                  lat: {origin.location.lat.toFixed(6)}, lon: {origin.location.lon.toFixed(6)}
                </div>
              ) : (
                <div className="text-sm text-gray-400">ยังไม่ระบุตำแหน่ง</div>
              )}
            </div>
          </div>
        </Card>

        {/* Destinations */}
        <div className="space-y-3">
          <div className="flex items-center justify-between">
            <SectionTitle>ปลายทาง</SectionTitle>
            <button className="rounded-xl bg-black px-4 py-2 text-white" onClick={addDest}>เพิ่มปลายทาง</button>
          </div>
          {destinations.length === 0 && (
            <Card>
              <div className="text-sm text-gray-500">ยังไม่มีปลายทาง กด “เพิ่มปลายทาง”</div>
            </Card>
          )}
          <div className="space-y-3">
            {destinations.map((d, i) => (
              <DestinationRow
                key={d.id}
                idx={i}
                dest={d}
                onChange={updateDest}
                onRemove={removeDest}
                onPickMap={(id) => setMapModal({ open: true, target: id })}
              />
            ))}
          </div>
        </div>

        {/* Summary */}
        <Card className="space-y-3">
          <SectionTitle>สรุปค่าโดยสาร</SectionTitle>
          {!origin.location && <div className="text-sm text-red-600">กรุณาระบุตำแหน่งต้นทาง</div>}
          <div className="space-y-2">
            {destinations.map((d) => {
              const r = perRoute.find((x) => x.id === d.id);
              return (
                <div key={d.id} className="flex items-center justify-between text-sm">
                  <div className="truncate">
                    {d.name || "ปลายทางไม่ระบุชื่อ"} {d.location ? `(${d.location.lat.toFixed(3)},${d.location.lon.toFixed(3)})` : ""}
                  </div>
                  <div>
                    {d.location ? `${Math.ceil(r.km)} กม. • ${Math.round(r.fare)} บาท` : "-"}
                  </div>
                </div>
              );
            })}
          </div>
          <div className="flex items-center justify-between border-t pt-2 mt-2">
            <div className="text-base font-semibold">รวมทั้งหมด</div>
            <div className="text-base font-semibold">{Math.round(totalFare)} บาท</div>
          </div>
        </Card>

        {/* Submit */}
        <button
          className="w-full rounded-2xl bg-black py-3 text-white text-base disabled:opacity-50"
          onClick={handleSubmit}
          disabled={!origin.location || destinations.length === 0 || destinations.some((d) => !d.location)}
        >
          บันทึกและส่งคำสั่ง
        </button>

        <footer className="py-8 text-center text-xs text-gray-400">Minimal UI • React • LIFF • Longdo</footer>
      </main>

      <MapPicker
        open={mapModal.open}
        onClose={() => setMapModal({ open: false, target: null })}
        onPick={handlePick}
        initial={
          mapModal.target === "origin"
            ? origin.location
            : destinations.find((d) => d.id === mapModal.target)?.location
        }
      />
    </div>
  );
}
