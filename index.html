<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡∏û‡∏±‡∏™‡∏î‡∏∏</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Longdo Map API -->
    <script src="https://api.longdo.com/map/?key=7fe4440cd70cb6961fe1fbfdcea94610"></script>

    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- Custom Styles -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Sarabun:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Sarabun', 'Inter', sans-serif;
            background-color: #f8f9fa;
        }
        .form-section {
            background-color: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .btn-primary {
            background-color: #06C755;
            color: white;
            font-weight: 600;
            border-radius: 0.5rem;
            padding: 0.75rem 1.5rem;
            transition: background-color 0.3s;
        }
        .btn-primary:hover {
            background-color: #05a546;
        }
        .btn-secondary {
            background-color: #e9ecef;
            color: #495057;
            font-weight: 500;
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            transition: background-color 0.3s;
        }
        .btn-secondary:hover {
            background-color: #dee2e6;
        }
        .input-field {
            width: 100%;
            border: 1px solid #ced4da;
            border-radius: 0.5rem;
            padding: 0.75rem;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        .input-field:focus {
            outline: none;
            border-color: #06C755;
            box-shadow: 0 0 0 2px rgba(6, 199, 85, 0.2);
        }
        #mapModal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            position: relative;
            background-color: #fefefe;
            margin: auto;
            border-radius: 0.5rem;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        #map {
            flex-grow: 1;
            width: 100%;
        }
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        #loading-overlay.hidden {
            display: none !important;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #06C755;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loading-text {
            margin-top: 1rem;
            color: #6B7280;
            font-size: 0.9rem;
        }
        #notification-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        #notification-modal.show {
            opacity: 1;
            visibility: visible;
        }
        .notification-content {
            background: white;
            padding: 2rem;
            border-radius: 0.75rem;
            text-align: center;
            max-width: 90%;
            width: 350px;
            box-shadow: 0 10px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        }
        .notification-content .icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        .notification-content .icon.success { color: #10B981; }
        .notification-content .icon.error { color: #EF4444; }

        /* Debug info */
        .debug-info {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            max-width: 300px;
            z-index: 1001;
        }
    </style>
</head>
<body class="bg-gray-50">

    <div id="loading-overlay" class="hidden" style="display: none;">
        <div class="spinner"></div>
        <div id="loading-text" class="loading-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
    </div>

    <div class="container mx-auto max-w-lg p-4">
        <header class="text-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏û‡∏±‡∏™‡∏î‡∏∏</h1>
            <p class="text-gray-500 mt-1">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô</p>
        </header>

        <form id="deliveryForm">
            <!-- Origin Section -->
            <div class="form-section">
                <h2 class="text-xl font-semibold text-gray-700 border-b pb-2 mb-4 flex items-center">
                    <i class="fas fa-box-open mr-3 text-green-500"></i>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á
                </h2>
                <div class="space-y-4">
                    <div>
                        <label for="senderName" class="block text-sm font-medium text-gray-600 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á</label>
                        <input type="text" id="senderName" class="input-field bg-gray-100" readonly>
                    </div>
                    <div>
                        <label for="senderPhone" class="block text-sm font-medium text-gray-600 mb-1">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</label>
                        <input type="text" inputmode="numeric" pattern="[0-9\-]+" id="senderPhone" class="input-field" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå" required autocomplete="off">
                    </div>
                    <div>
                        <label for="pickupTime" class="block text-sm font-medium text-gray-600 mb-1">‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏±‡∏î‡∏£‡∏±‡∏ö</label>
                        <input type="datetime-local" id="pickupTime" class="input-field" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-2">‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á</label>
                        <div class="flex space-x-2">
                            <button type="button" id="currentLocationBtn" class="btn-secondary w-full flex items-center justify-center"><i class="fas fa-location-arrow mr-2"></i>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</button>
                            <button type="button" id="originMapBtn" class="btn-secondary w-full flex items-center justify-center"><i class="fas fa-map-marked-alt mr-2"></i>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</button>
                        </div>
                        <div id="originAddress" class="mt-3 p-3 bg-gray-50 border rounded-lg text-gray-600 text-sm min-h-[40px]">
                            ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
                        </div>
                        <input type="hidden" id="originCoords">
                    </div>
                </div>
            </div>

            <!-- Destinations Section -->
            <div id="destinations-container">
                <!-- Destination items will be injected here -->
            </div>

            <button type="button" id="addDestinationBtn" class="w-full py-3 mb-6 border-2 border-dashed border-green-400 text-green-600 font-semibold rounded-lg hover:bg-green-50 transition-colors flex items-center justify-center">
                <i class="fas fa-plus-circle mr-2"></i>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á
            </button>

            <!-- Summary Section -->
            <div class="form-section">
                <h2 class="text-xl font-semibold text-gray-700 border-b pb-2 mb-4 flex items-center">
                    <i class="fas fa-receipt mr-3 text-green-500"></i>‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                </h2>
                <div class="space-y-2 text-gray-700">
                    <div class="flex justify-between">
                        <span>‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏£‡∏ß‡∏°:</span>
                        <span id="totalDistance" class="font-semibold">0.00 ‡∏Å‡∏°.</span>
                    </div>
                    <div class="flex justify-between text-xl">
                        <span class="font-semibold">‡∏Ñ‡πà‡∏≤‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ (‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì):</span>
                        <span id="shippingFee" class="font-bold text-green-600">‡∏ø0.00</span>
                    </div>
                </div>
            </div>

            <button type="submit" class="btn-primary w-full text-lg">
                ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
            </button>
        </form>
    </div>

    <!-- Map Modal -->
    <div id="mapModal">
        <div class="modal-content">
            <div class="p-4 bg-white border-b flex items-center">
                <input type="text" id="mapSearch" class="input-field" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà...">
                <button type="button" id="closeMapBtn" class="ml-2 text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <div id="map"></div>
            <div class="p-4 bg-white border-t">
                <div id="selectedMapAddress" class="mb-3 p-2 bg-gray-100 rounded-md text-sm text-gray-700">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</div>
                <button type="button" id="confirmLocationBtn" class="btn-primary w-full">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ô‡∏µ‡πâ</button>
            </div>
        </div>
    </div>

    <!-- Notification Modal -->
    <div id="notification-modal">
        <div class="notification-content">
            <div id="notification-icon" class="icon"></div>
            <p id="notification-message" class="text-gray-700 mb-4"></p>
            <button id="notification-close-btn" class="btn-primary">‡∏ï‡∏Å‡∏•‡∏á</button>
        </div>
    </div>

    <!-- Debug Info -->
    <div id="debug-info" class="debug-info" style="display: none;"></div>

    <!-- LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        // --- CONFIGURATION ---
        const LIFF_ID = "2007906947-zQ0mRjXg"; 
        const GAS_WEB_APP_URL = "https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec"; // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
        const INIT_TIMEOUT = 15000; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏õ‡πá‡∏ô 15 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
        const MAP_LOAD_TIMEOUT = 10000; // Timeout ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà

        // --- DOM ELEMENTS ---
        const form = document.getElementById('deliveryForm');
        const senderNameInput = document.getElementById('senderName');
        const pickupTimeInput = document.getElementById('pickupTime');
        const addDestinationBtn = document.getElementById('addDestinationBtn');
        const destinationsContainer = document.getElementById('destinations-container');
        const totalDistanceEl = document.getElementById('totalDistance');
        const shippingFeeEl = document.getElementById('shippingFee');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingText = document.getElementById('loading-text');
        const notificationModal = document.getElementById('notification-modal');
        const notificationIcon = document.getElementById('notification-icon');
        const notificationMessage = document.getElementById('notification-message');
        const notificationCloseBtn = document.getElementById('notification-close-btn');
        const debugInfo = document.getElementById('debug-info');

        // --- STATE VARIABLES ---
        let destinationCounter = 0;
        let map;
        let currentMapTarget = null;
        let selectedLocation = null;
        let mapApiLoaded = false;

        // --- DEBUG FUNCTIONS ---
        function addDebugLog(message) {
            console.log(message);
            const timestamp = new Date().toLocaleTimeString();
            debugInfo.innerHTML += `[${timestamp}] ${message}<br>`;
            debugInfo.style.display = 'block';
            // Keep only last 10 messages
            const lines = debugInfo.innerHTML.split('<br>');
            if (lines.length > 10) {
                debugInfo.innerHTML = lines.slice(-10).join('<br>');
            }
        }

        function updateLoadingText(text) {
            loadingText.textContent = text;
            addDebugLog(text);
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', initializeApp);

        async function initializeApp() {
            try {
                addDebugLog("üöÄ App initialization started");
                showLoading(true);
                updateLoadingText("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏≠‡∏õ...");

                // Step 1: Configuration Check
                updateLoadingText("‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤...");
                await checkConfiguration();

                // Step 2: Check Map API
                updateLoadingText("‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Longdo Map API...");
                await checkMapAPI();

                // Step 3: LIFF Initialization
                updateLoadingText("‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö LINE...");
                await initializeLIFF();

                // Step 4: Setup App
                updateLoadingText("‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô...");
                await setupApp();

                addDebugLog("‚úÖ App initialized successfully");
                
                // Force hide loading with delay to ensure everything is ready
                setTimeout(() => {
                    addDebugLog("üéâ Hiding loading overlay");
                    showLoading(false);
                    addDebugLog("üéä App is now ready for use!");
                }, 500);

            } catch (error) {
                addDebugLog(`‚ùå Initialization failed: ${error.message}`);
                handleInitializationError(error);
            }
        }

        async function checkConfiguration() {
            return new Promise((resolve, reject) => {
                try {
                    if (LIFF_ID === "YOUR_LIFF_ID" || LIFF_ID === "") {
                        throw new Error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà LIFF ID ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î");
                    }
                    
                    if (GAS_WEB_APP_URL.includes("YOUR_SCRIPT_ID")) {
                        console.warn("‚ö†Ô∏è Google Apps Script URL ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ - ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô");
                    }

                    addDebugLog("‚úÖ Configuration check passed");
                    setTimeout(resolve, 500); // Simulate async operation
                } catch (error) {
                    reject(error);
                }
            });
        }

        async function checkMapAPI() {
            return new Promise((resolve, reject) => {
                const timeout = setTimeout(() => {
                    reject(new Error("Longdo Map API ‡πÇ‡∏´‡∏•‡∏î‡∏•‡πà‡∏≤‡∏ä‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ - ‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢‡∏´‡∏£‡∏∑‡∏≠ API Key"));
                }, MAP_LOAD_TIMEOUT);

                try {
                    if (typeof longdo === 'undefined') {
                        throw new Error("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î Longdo Map API ‡πÑ‡∏î‡πâ - ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï");
                    }

                    // Test map creation
                    const testDiv = document.createElement('div');
                    testDiv.style.width = '1px';
                    testDiv.style.height = '1px';
                    testDiv.style.visibility = 'hidden';
                    document.body.appendChild(testDiv);

                    const testMap = new longdo.Map({ 
                        placeholder: testDiv,
                        zoom: 10,
                        location: { lat: 13.7563, lon: 100.5018 }
                    });

                    setTimeout(() => {
                        document.body.removeChild(testDiv);
                        mapApiLoaded = true;
                        addDebugLog("‚úÖ Longdo Map API is working");
                        clearTimeout(timeout);
                        resolve();
                    }, 1000);

                } catch (error) {
                    clearTimeout(timeout);
                    reject(new Error(`Longdo Map API Error: ${error.message}`));
                }
            });
        }

        async function initializeLIFF() {
            return new Promise((resolve, reject) => {
                const timeout = setTimeout(() => {
                    reject(new Error("‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö LINE ‡∏•‡πà‡∏≤‡∏ä‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ"));
                }, INIT_TIMEOUT);

                liff.init({ liffId: LIFF_ID })
                    .then(() => {
                        clearTimeout(timeout);
                        addDebugLog("‚úÖ LIFF initialized successfully");
                        
                        if (!liff.isLoggedIn()) {
                            addDebugLog("üîê User not logged in, redirecting...");
                            liff.login();
                            return;
                        }
                        
                        addDebugLog("üë§ User is logged in");
                        resolve();
                    })
                    .catch((error) => {
                        clearTimeout(timeout);
                        let errorMessage = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö LINE";
                        
                        if (error.message.includes("channel not found")) {
                            errorMessage = "‡πÑ‡∏°‡πà‡∏û‡∏ö LIFF Channel - ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö LIFF ID";
                        } else if (error.message.includes("network")) {
                            errorMessage = "‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï";
                        }
                        
                        reject(new Error(errorMessage));
                    });
            });
        }

        async function setupApp() {
            return new Promise(async (resolve, reject) => {
                try {
                    addDebugLog("üîÑ Starting app setup...");
                    
                    // Get user profile
                    addDebugLog("üë§ Getting user profile...");
                    const profile = await liff.getProfile();
                    senderNameInput.value = profile.displayName;
                    addDebugLog(`üë§ Profile loaded: ${profile.displayName}`);

                    // Setup event listeners
                    addDebugLog("üéØ Setting up event listeners...");
                    setupEventListeners();
                    addDebugLog("üéØ Event listeners setup complete");

                    // Add first destination
                    addDebugLog("üìç Adding first destination...");
                    addDestination();
                    addDebugLog("üìç First destination added");

                    // Set default pickup time
                    addDebugLog("‚è∞ Setting default pickup time...");
                    setDefaultPickupTime();
                    addDebugLog("‚è∞ Default pickup time set");

                    addDebugLog("‚úÖ App setup completed successfully");
                    resolve();
                } catch (error) {
                    addDebugLog(`‚ùå App setup failed: ${error.message}`);
                    reject(error);
                }
            });
        }

        function handleInitializationError(error) {
            console.error("Initialization failed:", error);
            
            let errorMessage = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏Ñ‡∏≤‡∏î‡∏Ñ‡∏¥‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á";
            
            if (error.message) {
                errorMessage = error.message;
            }

            showMessage(errorMessage, true);
            showLoading(false);

            // Show retry option after 3 seconds
            setTimeout(() => {
                if (confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
                    location.reload();
                }
            }, 3000);
        }

        function setDefaultPickupTime() {
            const now = new Date();
            now.setHours(now.getHours() + 1);
            const year = now.getFullYear();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const day = now.getDate().toString().padStart(2, '0');
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            pickupTimeInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        function setupEventListeners() {
            addDestinationBtn.addEventListener('click', addDestination);
            form.addEventListener('submit', handleFormSubmit);
            document.getElementById('currentLocationBtn').addEventListener('click', getCurrentLocation);
            document.getElementById('originMapBtn').addEventListener('click', () => openMapModal('origin'));
            document.getElementById('closeMapBtn').addEventListener('click', closeMapModal);
            document.getElementById('confirmLocationBtn').addEventListener('click', confirmLocation);
            document.getElementById('mapSearch').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') { e.preventDefault(); searchMap(); }
            });
            notificationCloseBtn.addEventListener('click', () => notificationModal.classList.remove('show'));
        }
        
        function addDestination() {
            destinationCounter++;
            const id = `destination-${destinationCounter}`;
            const destinationHTML = `
                <div class="form-section" id="${id}">
                    <div class="flex justify-between items-center border-b pb-2 mb-4">
                        <h2 class="text-xl font-semibold text-gray-700 flex items-center">
                            <i class="fas fa-map-marker-alt mr-3 text-red-500"></i>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á #${destinationCounter}
                        </h2>
                        ${destinationCounter > 1 ? `<button type="button" class="text-red-500 hover:text-red-700 remove-destination-btn" data-target="${id}">&times; ‡∏•‡∏ö</button>` : ''}
                    </div>
                    <div class="space-y-4">
                        <div><label for="recipientName-${id}" class="block text-sm font-medium text-gray-600 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö</label><input type="text" id="recipientName-${id}" class="input-field" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö" required></div>
                        <div><label for="recipientPhone-${id}" class="block text-sm font-medium text-gray-600 mb-1">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö</label><input type="tel" id="recipientPhone-${id}" class="input-field" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå" required></div>
                        <div><label class="block text-sm font-medium text-gray-600 mb-2">‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á</label><button type="button" class="btn-secondary w-full destination-map-btn" data-target="${id}"><i class="fas fa-map-marked-alt mr-2"></i>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</button><div id="address-${id}" class="mt-3 p-3 bg-gray-50 border rounded-lg text-gray-600 text-sm min-h-[40px]">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</div><input type="hidden" id="coords-${id}"></div>
                    </div>
                </div>`;
            destinationsContainer.insertAdjacentHTML('beforeend', destinationHTML);
            document.querySelector(`.destination-map-btn[data-target="${id}"]`).addEventListener('click', () => openMapModal(id));
            if (destinationCounter > 1) {
                document.querySelector(`.remove-destination-btn[data-target="${id}"]`).addEventListener('click', (e) => removeDestination(e.target.dataset.target));
            }
        }

        function removeDestination(id) { 
            document.getElementById(id).remove(); 
            calculateTotal(); 
        }

        function getCurrentLocation() {
            showLoading(true);
            updateLoadingText("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô...");
            
            if (!navigator.geolocation) { 
                showMessage("‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á", true); 
                showLoading(false); 
                return; 
            }
            
            const options = {
                enableHighAccuracy: true,
                timeout: 15000,
                maximumAge: 60000
            };
            
            navigator.geolocation.getCurrentPosition(
                position => {
                    const coords = { lat: position.coords.latitude, lon: position.coords.longitude };
                    addDebugLog(`üìç Got current location: ${coords.lat}, ${coords.lon}`);
                    getAddressFromCoords(coords, (address) => { 
                        updateLocationUI('origin', coords, address); 
                        showLoading(false); 
                    });
                },
                (error) => {
                    addDebugLog(`‚ùå Geolocation error: ${error.message}`);
                    let errorMsg = "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÑ‡∏î‡πâ";
                    if (error.code === error.PERMISSION_DENIED) {
                        errorMsg = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå";
                    } else if (error.code === error.TIMEOUT) {
                        errorMsg = "‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏≤‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ";
                    }
                    showMessage(errorMsg, true); 
                    showLoading(false); 
                },
                options
            );
        }

        function openMapModal(target) { 
            if (!mapApiLoaded) {
                showMessage("‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÉ‡∏ô‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á", true);
                return;
            }
            currentMapTarget = target; 
            document.getElementById('mapModal').style.display = 'block'; 
            if (!map) initMap(); 
        }

        function closeMapModal() { 
            document.getElementById('mapModal').style.display = 'none'; 
            document.getElementById('selectedMapAddress').textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà'; 
            document.getElementById('mapSearch').value = ''; 
            selectedLocation = null; 
        }

        function initMap() {
            try {
                map = new longdo.Map({ 
                    placeholder: document.getElementById('map'),
                    zoom: 13,
                    location: { lat: 13.7563, lon: 100.5018 } // Default to Bangkok
                });
                
                map.Event.bind('click', (e) => {
                    const location = map.location();
                    const marker = new longdo.Marker(location, { title: '‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å' });
                    map.Overlays.clear(); 
                    map.Overlays.add(marker); 
                    map.zoom(16, true);
                    const coords = { lat: location.lat, lon: location.lon };
                    getAddressFromCoords(coords, (address) => { 
                        selectedLocation = { ...coords, address }; 
                        document.getElementById('selectedMapAddress').textContent = address; 
                    });
                });
                
                addDebugLog("üó∫Ô∏è Map initialized successfully");
            } catch (error) {
                addDebugLog(`‚ùå Map initialization failed: ${error.message}`);
                showMessage("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á", true);
            }
        }

        function searchMap() {
            const keyword = document.getElementById('mapSearch').value;
            if (!keyword) return;
            
            addDebugLog(`üîç Searching map for: ${keyword}`);
            
            try {
                map.Search.search(keyword, {
                    callback: (result) => {
                        if (result.data.length > 0) {
                            const firstResult = result.data[0];
                            const location = { lat: firstResult.lat, lon: firstResult.lon };
                            map.location(location, true); 
                            map.zoom(16, true);
                            const marker = new longdo.Marker(location);
                            map.Overlays.clear(); 
                            map.Overlays.add(marker);
                            getAddressFromCoords(location, (address) => { 
                                selectedLocation = { ...location, address }; 
                                document.getElementById('selectedMapAddress').textContent = address; 
                            });
                            addDebugLog(`‚úÖ Found location: ${firstResult.name}`);
                        } else { 
                            showMessage('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤', true); 
                        }
                    },
                    error: (error) => {
                        addDebugLog(`‚ùå Map search error: ${error.message}`);
                        showMessage('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤', true);
                    }
                });
            } catch (error) {
                addDebugLog(`‚ùå Map search failed: ${error.message}`);
                showMessage('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', true);
            }
        }

        function getAddressFromCoords(coords, callback) {
            if (!mapApiLoaded) {
                callback('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏î‡πâ');
                return;
            }
            
            try {
                map.Search.search(coords, {
                    callback: (result) => {
                        const address = result.data.length > 0 ? 
                            `${result.data[0].name}, ${result.data[0].address}` : 
                            '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏î‡πâ';
                        callback(address);
                    },
                    error: (error) => {
                        addDebugLog(`‚ùå Address lookup error: ${error.message}`);
                        callback('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏î‡πâ');
                    }
                });
            } catch (error) {
                addDebugLog(`‚ùå Address lookup failed: ${error.message}`);
                callback('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏î‡πâ');
            }
        }

        function confirmLocation() {
            if (selectedLocation && currentMapTarget) { 
                updateLocationUI(currentMapTarget, 
                    { lat: selectedLocation.lat, lon: selectedLocation.lon }, 
                    selectedLocation.address
                ); 
                closeMapModal(); 
            } else { 
                showMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô', true); 
            }
        }

        function updateLocationUI(target, coords, address) {
            const addressEl = (target === 'origin') ? 
                document.getElementById('originAddress') : 
                document.getElementById(`address-${target}`);
            const coordsEl = (target === 'origin') ? 
                document.getElementById('originCoords') : 
                document.getElementById(`coords-${target}`);
            
            addressEl.textContent = address;
            coordsEl.value = `${coords.lat},${coords.lon}`;
            
            addDebugLog(`üìç Location updated for ${target}: ${address}`);
            calculateTotal();
        }

        function calculateTotal() {
            const originCoordsStr = document.getElementById('originCoords').value;
            if (!originCoordsStr) {
                totalDistanceEl.textContent = '0.00 ‡∏Å‡∏°.';
                shippingFeeEl.textContent = '‡∏ø0.00';
                return;
            }

            const waypoints = [longdo.Util.stringToLocation(originCoordsStr)];
            document.querySelectorAll('[id^="destination-"]').forEach(el => {
                const coordsStr = el.querySelector('[id^="coords-"]').value;
                if (coordsStr) waypoints.push(longdo.Util.stringToLocation(coordsStr));
            });

            if (waypoints.length < 2) { 
                totalDistanceEl.textContent = '0.00 ‡∏Å‡∏°.'; 
                shippingFeeEl.textContent = '‡∏ø0.00'; 
                return; 
            }

            if (!mapApiLoaded || !map) {
                // Fallback: simple distance calculation
                calculateSimpleDistance(waypoints);
                return;
            }

            try {
                map.Route.get({
                    locationList: waypoints,
                    callback: (result) => {
                        if (result && result.distance) {
                            const distanceKm = result.distance / 1000;
                            const fee = calculateFee(distanceKm);
                            totalDistanceEl.textContent = `${distanceKm.toFixed(2)} ‡∏Å‡∏°.`;
                            shippingFeeEl.textContent = `‡∏ø${fee.toFixed(2)}`;
                            addDebugLog(`üí∞ Distance: ${distanceKm.toFixed(2)}km, Fee: ‡∏ø${fee.toFixed(2)}`);
                        } else {
                            calculateSimpleDistance(waypoints);
                        }
                    },
                    error: (error) => {
                        addDebugLog(`‚ùå Route calculation error: ${error.message}`);
                        calculateSimpleDistance(waypoints);
                    }
                });
            } catch (error) {
                addDebugLog(`‚ùå Route calculation failed: ${error.message}`);
                calculateSimpleDistance(waypoints);
            }
        }

        function calculateSimpleDistance(waypoints) {
            // Simple haversine distance calculation as fallback
            let totalDistance = 0;
            for (let i = 1; i < waypoints.length; i++) {
                const d = haversineDistance(waypoints[i-1], waypoints[i]);
                totalDistance += d;
            }
            const fee = calculateFee(totalDistance);
            totalDistanceEl.textContent = `${totalDistance.toFixed(2)} ‡∏Å‡∏°. (‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì)`;
            shippingFeeEl.textContent = `‡∏ø${fee.toFixed(2)}`;
            addDebugLog(`üí∞ Simple distance: ${totalDistance.toFixed(2)}km, Fee: ‡∏ø${fee.toFixed(2)}`);
        }

        function haversineDistance(pos1, pos2) {
            const R = 6371; // Earth's radius in km
            const dLat = (pos2.lat - pos1.lat) * Math.PI / 180;
            const dLon = (pos2.lon - pos1.lon) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(pos1.lat * Math.PI / 180) * Math.cos(pos2.lat * Math.PI / 180) * 
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function calculateFee(km) {
            if (km <= 0) return 0;
            if (km <= 5) return 30;
            let fee = 30;
            if (km > 5 && km < 13) { 
                fee += (km - 5) * 5; 
            } else if (km >= 13) { 
                fee += (12 - 5) * 5; 
                fee += 10; 
                if (km > 13) fee += (km - 13) * 15; 
            }
            return fee;
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            
            addDebugLog("üìù Form submission started");
            showLoading(true);
            updateLoadingText("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...");

            try {
                const originCoords = document.getElementById('originCoords').value.split(',');
                const formData = {
                    origin: { 
                        name: senderNameInput.value, 
                        phone: document.getElementById('senderPhone').value, 
                        pickupTime: pickupTimeInput.value, 
                        address: document.getElementById('originAddress').textContent, 
                        lat: originCoords[0] ? parseFloat(originCoords[0]) : null, 
                        lon: originCoords[1] ? parseFloat(originCoords[1]) : null 
                    },
                    destinations: [],
                    summary: { 
                        totalDistance: totalDistanceEl.textContent, 
                        shippingFee: shippingFeeEl.textContent 
                    }
                };

                let isFormValid = !!(formData.origin.phone && formData.origin.pickupTime && formData.origin.lat);
                
                document.querySelectorAll('[id^="destination-"]').forEach(el => {
                    const id = el.id;
                    const destCoords = document.getElementById(`coords-${id}`).value.split(',');
                    const destinationData = { 
                        name: document.getElementById(`recipientName-${id}`).value, 
                        phone: document.getElementById(`recipientPhone-${id}`).value, 
                        address: document.getElementById(`address-${id}`).textContent, 
                        lat: destCoords[0] ? parseFloat(destCoords[0]) : null, 
                        lon: destCoords[1] ? parseFloat(destCoords[1]) : null 
                    };
                    if (!destinationData.name || !destinationData.phone || !destinationData.lat) {
                        isFormValid = false;
                    }
                    formData.destinations.push(destinationData);
                });

                if (!isFormValid) { 
                    throw new Error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á ‡πÅ‡∏•‡∏∞‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏à‡∏∏‡∏î‡∏´‡∏°‡∏≤‡∏¢'); 
                }

                updateLoadingText("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...");
                
                // Check if GAS URL is configured
                if (GAS_WEB_APP_URL.includes("YOUR_SCRIPT_ID")) {
                    addDebugLog("‚ö†Ô∏è Google Apps Script URL not configured - simulating success");
                    // Simulate successful submission
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    showMessage('‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! (‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏î‡∏™‡∏≠‡∏ö)', false);
                } else {
                    // Actual submission
                    const response = await fetch(GAS_WEB_APP_URL, { 
                        method: 'POST', 
                        mode: 'no-cors', 
                        headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify(formData) 
                    });
                    
                    addDebugLog("‚úÖ Form submitted successfully");
                    showMessage('‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', false);
                }

                // Close window after success
                setTimeout(() => { 
                    if (liff.isInClient()) {
                        liff.closeWindow(); 
                    } else {
                        // For web browser testing
                        if (confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
                            location.reload();
                        }
                    }
                }, 2000);

            } catch (error) {
                addDebugLog(`‚ùå Form submission failed: ${error.message}`);
                showMessage(error.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', true);
            } finally {
                showLoading(false);
            }
        }

        function showLoading(isLoading) { 
            addDebugLog(`üîÑ showLoading called: ${isLoading}`);
            
            if (isLoading) {
                loadingOverlay.style.display = 'flex';
                loadingOverlay.classList.remove('hidden');
                addDebugLog("üëÅÔ∏è Loading overlay shown");
            } else {
                loadingOverlay.style.display = 'none';
                loadingOverlay.classList.add('hidden');
                addDebugLog("üö´ Loading overlay hidden");
            }
            
            if (!isLoading) {
                updateLoadingText("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...");
            }
        }
        
        function showMessage(message, isError = false) {
            notificationMessage.textContent = message;
            notificationIcon.className = isError ? 'icon error' : 'icon success';
            notificationIcon.innerHTML = isError ? 
                '<i class="fas fa-times-circle"></i>' : 
                '<i class="fas fa-check-circle"></i>';
            notificationModal.classList.add('show');
        }

        // Add manual override button for testing
        setTimeout(() => {
            if (!loadingOverlay.classList.contains('hidden')) {
                addDebugLog("‚ö†Ô∏è Loading still visible after 20 seconds - adding override button");
                const overrideBtn = document.createElement('button');
                overrideBtn.textContent = 'Force Close Loading (Debug)';
                overrideBtn.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:10001;background:red;color:white;padding:10px;border:none;border-radius:5px;cursor:pointer;';
                overrideBtn.onclick = () => {
                    addDebugLog("üõ†Ô∏è Manual loading override triggered");
                    showLoading(false);
                    overrideBtn.remove();
                };
                document.body.appendChild(overrideBtn);
            }
        }, 20000);

        // Add error handling for uncaught errors
        window.addEventListener('error', (event) => {
            addDebugLog(`üí• Uncaught error: ${event.message}`);
            console.error('Uncaught error:', event.error);
        });

        window.addEventListener('unhandledrejection', (event) => {
            addDebugLog(`üí• Unhandled promise rejection: ${event.reason}`);
            console.error('Unhandled promise rejection:', event.reason);
        });

    </script>
</body>
</html>
